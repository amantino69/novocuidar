<div class="anamnesis-container">
  <!-- Indicador de auto-save flutuante no canto -->
  <div class="auto-save-floating">
    @if (isSaving) {
      <span class="saving-status">
        <span class="spinner-small"></span>
        Salvando...
      </span>
    } @else if (lastSaved) {
      <span class="saved-status">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Salvo {{ lastSaved | date:'HH:mm' }}
      </span>
    }
  </div>

  <!-- Conteúdo único rolável com todas as seções SOAP -->
  <form [formGroup]="anamnesisForm" class="anamnesis-form">
    <div class="soap-unified-content">
      
      <!-- ========================================== -->
      <!-- S - SUBJETIVO -->
      <!-- ========================================== -->
      <div class="soap-section" data-section="S">
        <div class="section-header minimal">
          <span class="section-letter blue">S</span>
          <button type="button" class="expand-btn" (click)="openExpandedEditor('subjective')" title="Expandir para edição">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="15 3 21 3 21 9"></polyline>
              <polyline points="9 21 3 21 3 15"></polyline>
              <line x1="21" y1="3" x2="14" y2="10"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
          </button>
        </div>
        
        <div class="section-body">
          <div class="form-section">
            <label class="field-label"><app-icon name="alert-circle" [size]="16" /> Queixa Principal (QP)</label>
            <textarea formControlName="chiefComplaint" rows="2" placeholder="Ex: Dor de cabeça há 3 dias..."></textarea>
          </div>

          <div class="form-section">
            <label class="field-label"><app-icon name="file" [size]="16" /> História da Doença Atual (HDA)</label>
            <textarea formControlName="presentIllnessHistory" rows="3" placeholder="Início, evolução, fatores de melhora/piora..."></textarea>
          </div>

          <div class="form-section">
            <label class="field-label"><app-icon name="clock" [size]="16" /> História Patológica Pregressa (HPP)</label>
            <textarea formControlName="pastMedicalHistory" rows="2" placeholder="Doenças crônicas, internações, cirurgias..."></textarea>
          </div>

          <div class="form-section" formGroupName="personalHistory">
            <label class="field-label"><app-icon name="user" [size]="16" /> Antecedentes Pessoais</label>
            <div class="form-grid compact">
              <div class="form-field"><label>Doenças Anteriores</label><textarea formControlName="previousDiseases" rows="1" placeholder="Diabetes, Hipertensão..."></textarea></div>
              <div class="form-field"><label>Cirurgias</label><textarea formControlName="surgeries" rows="1" placeholder="Cirurgias realizadas..."></textarea></div>
              <div class="form-field"><label>Internações</label><textarea formControlName="hospitalizations" rows="1" placeholder="Internações..."></textarea></div>
              <div class="form-field"><label>Alergias</label><textarea formControlName="allergies" rows="1" placeholder="Medicamentos, alimentos..."></textarea></div>
              <div class="form-field"><label>Medicações em Uso</label><textarea formControlName="currentMedications" rows="1" placeholder="Medicações atuais..."></textarea></div>
              <div class="form-field"><label>Vacinação</label><textarea formControlName="vaccinations" rows="1" placeholder="Estado vacinal..."></textarea></div>
            </div>
          </div>

          <div class="form-section">
            <label class="field-label"><app-icon name="users" [size]="16" /> Antecedentes Familiares</label>
            <textarea formControlName="familyHistory" rows="2" placeholder="Doenças na família..."></textarea>
          </div>

          <div class="form-section" formGroupName="lifestyle">
            <label class="field-label"><app-icon name="activity" [size]="16" /> Hábitos de Vida</label>
            <div class="form-grid compact">
              <div class="form-field"><label>Alimentação</label><textarea formControlName="diet" rows="1" placeholder="Padrão alimentar..."></textarea></div>
              <div class="form-field"><label>Atividade Física</label><textarea formControlName="physicalActivity" rows="1" placeholder="Frequência..."></textarea></div>
              <div class="form-field"><label>Tabagismo</label><textarea formControlName="smoking" rows="1" placeholder="Sim/Não..."></textarea></div>
              <div class="form-field"><label>Etilismo</label><textarea formControlName="alcohol" rows="1" placeholder="Frequência..."></textarea></div>
              <div class="form-field"><label>Uso de Drogas</label><textarea formControlName="drugs" rows="1" placeholder="Sim/Não..."></textarea></div>
              <div class="form-field"><label>Sono</label><textarea formControlName="sleep" rows="1" placeholder="Qualidade..."></textarea></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ========================================== -->
      <!-- O - OBJETIVO -->
      <!-- ========================================== -->
      <div class="soap-section" data-section="O">
        <div class="section-header minimal">
          <span class="section-letter green">O</span>
          <button type="button" class="expand-btn" (click)="openExpandedEditor('objective')" title="Expandir para edição">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="15 3 21 3 21 9"></polyline>
              <polyline points="9 21 3 21 3 15"></polyline>
              <line x1="21" y1="3" x2="14" y2="10"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
          </button>
        </div>
        
        <div class="section-body">
          <div class="form-section" formGroupName="systemsReview">
            <label class="field-label"><app-icon name="stethoscope" [size]="16" /> Revisão de Sistemas</label>
            <div class="form-grid compact">
              <div class="form-field"><label>Cardiovascular</label><textarea formControlName="cardiovascular" rows="1" placeholder="Dor torácica, palpitações..."></textarea></div>
              <div class="form-field"><label>Respiratório</label><textarea formControlName="respiratory" rows="1" placeholder="Tosse, dispneia..."></textarea></div>
              <div class="form-field"><label>Gastrointestinal</label><textarea formControlName="gastrointestinal" rows="1" placeholder="Náuseas, diarreia..."></textarea></div>
              <div class="form-field"><label>Geniturinário</label><textarea formControlName="genitourinary" rows="1" placeholder="Disúria..."></textarea></div>
              <div class="form-field"><label>Musculoesquelético</label><textarea formControlName="musculoskeletal" rows="1" placeholder="Dores articulares..."></textarea></div>
              <div class="form-field"><label>Neurológico</label><textarea formControlName="neurological" rows="1" placeholder="Cefaleia, tontura..."></textarea></div>
              <div class="form-field"><label>Psiquiátrico</label><textarea formControlName="psychiatric" rows="1" placeholder="Humor, ansiedade..."></textarea></div>
              <div class="form-field"><label>Endócrino</label><textarea formControlName="endocrine" rows="1" placeholder="Sede, poliúria..."></textarea></div>
              <div class="form-field"><label>Hematológico</label><textarea formControlName="hematologic" rows="1" placeholder="Sangramentos..."></textarea></div>
            </div>
          </div>

          <div class="form-section">
            <label class="field-label"><app-icon name="eye" [size]="16" /> Exame Físico / Dados Objetivos</label>
            <textarea formControlName="objectiveExam" rows="4" placeholder="PA, FC, FR, Temp, SpO2, inspeção, palpação, ausculta..."></textarea>
          </div>
        </div>
      </div>

      <!-- ========================================== -->
      <!-- A - AVALIAÇÃO -->
      <!-- ========================================== -->
      <div class="soap-section" data-section="A">
        <div class="section-header minimal">
          <span class="section-letter amber">A</span>
          <button type="button" class="expand-btn" (click)="openExpandedEditor('assessment')" title="Expandir para edição">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="15 3 21 3 21 9"></polyline>
              <polyline points="9 21 3 21 3 15"></polyline>
              <line x1="21" y1="3" x2="14" y2="10"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
          </button>
        </div>
        
        <div class="section-body">
          <div class="form-section">
            <label class="field-label"><app-icon name="file-text" [size]="16" /> Hipóteses Diagnósticas</label>
            <textarea formControlName="assessment" rows="4" placeholder="CID-10, diagnósticos diferenciais, raciocínio clínico..."></textarea>
          </div>
        </div>
      </div>

      <!-- ========================================== -->
      <!-- P - PLANO -->
      <!-- ========================================== -->
      <div class="soap-section" data-section="P">
        <div class="section-header minimal">
          <span class="section-letter purple">P</span>
          <button type="button" class="expand-btn" (click)="openExpandedEditor('plan')" title="Expandir para edição">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <polyline points="15 3 21 3 21 9"></polyline>
              <polyline points="9 21 3 21 3 15"></polyline>
              <line x1="21" y1="3" x2="14" y2="10"></line>
              <line x1="3" y1="21" x2="10" y2="14"></line>
            </svg>
          </button>
        </div>
        
        <div class="section-body">
          <div class="form-section">
            <label class="field-label"><app-icon name="edit" [size]="16" /> Conduta e Plano Terapêutico</label>
            <textarea formControlName="plan" rows="4" placeholder="Medicações, orientações, exames, encaminhamentos..."></textarea>
          </div>

          <div class="form-section">
            <label class="field-label"><app-icon name="file" [size]="16" /> Observações Adicionais</label>
            <textarea formControlName="additionalNotes" rows="2" placeholder="Informações adicionais..."></textarea>
          </div>
        </div>
      </div>

    </div>
  </form>

  <!-- Modal de Edição Expandida -->
  @if (expandedSection) {
    <div class="expanded-editor-overlay" (click)="closeExpandedEditor()">
      <div class="expanded-editor-modal" (click)="$event.stopPropagation()">
        <div class="expanded-header" [class]="expandedSection">
          <span class="section-info">
            <span class="letter">{{ getExpandedSectionLetter() }}</span>
            <span class="title">{{ getExpandedSectionTitle() }}</span>
          </span>
          <button type="button" class="close-btn" (click)="closeExpandedEditor()">
            <app-icon name="x" [size]="18" />
          </button>
        </div>
        <div class="expanded-body">
          @switch (expandedSection) {
            @case ('subjective') {
              <div class="expanded-form" [formGroup]="anamnesisForm">
                <div class="field-group">
                  <label>Queixa Principal (QP)</label>
                  <textarea formControlName="chiefComplaint" rows="3" placeholder="Ex: Dor de cabeça há 3 dias..."></textarea>
                </div>
                <div class="field-group">
                  <label>História da Doença Atual (HDA)</label>
                  <textarea formControlName="presentIllnessHistory" rows="4" placeholder="Início, evolução, fatores de melhora/piora..."></textarea>
                </div>
                <div class="field-group">
                  <label>História Patológica Pregressa (HPP)</label>
                  <textarea formControlName="pastMedicalHistory" rows="3" placeholder="Doenças crônicas, internações, cirurgias..."></textarea>
                </div>
                <div class="field-group">
                  <label>Antecedentes Familiares</label>
                  <textarea formControlName="familyHistory" rows="3" placeholder="Doenças na família..."></textarea>
                </div>
              </div>
            }
            @case ('objective') {
              <div class="expanded-form" [formGroup]="anamnesisForm">
                <div class="field-group">
                  <label>Exame Físico / Dados Objetivos</label>
                  <textarea formControlName="objectiveExam" rows="8" placeholder="PA, FC, FR, Temp, SpO2, inspeção, palpação, ausculta..."></textarea>
                </div>
              </div>
            }
            @case ('assessment') {
              <div class="expanded-form" [formGroup]="anamnesisForm">
                <div class="field-group">
                  <label>Hipóteses Diagnósticas</label>
                  <textarea formControlName="assessment" rows="10" placeholder="CID-10, diagnósticos diferenciais, raciocínio clínico..."></textarea>
                </div>
              </div>
            }
            @case ('plan') {
              <div class="expanded-form" [formGroup]="anamnesisForm">
                <div class="field-group">
                  <label>Conduta e Plano Terapêutico</label>
                  <textarea formControlName="plan" rows="8" placeholder="Medicações, orientações, exames, encaminhamentos..."></textarea>
                </div>
                <div class="field-group">
                  <label>Observações Adicionais</label>
                  <textarea formControlName="additionalNotes" rows="4" placeholder="Informações adicionais..."></textarea>
                </div>
              </div>
            }
          }
        </div>
        <div class="expanded-footer">
          <span class="auto-save-hint">As alterações são salvas automaticamente</span>
          <button type="button" class="done-btn" (click)="closeExpandedEditor()">
            <app-icon name="check" [size]="16" />
            Concluído
          </button>
        </div>
      </div>
    </div>
  }
</div>
