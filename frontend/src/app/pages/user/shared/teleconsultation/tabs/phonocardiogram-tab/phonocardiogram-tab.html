<div class="phonocardiogram-tab">
  <div class="tab-header">
    <div class="tab-header__title">
      <app-icon name="headphones" [size]="24"></app-icon>
      <h3>Fonocardiograma</h3>
    </div>
    @if (latency > 0) {
      <div class="latency-indicator" [class.high]="latency > 200">
        <app-icon name="activity" [size]="14"></app-icon>
        <span>{{ latency }}ms</span>
      </div>
    }
  </div>

  <div class="content">
    <!-- Seleção de dispositivo (só para paciente) -->
    @if (isPatient && audioDevices.length > 0) {
      <div class="device-selector">
        <label for="audioDevice">Dispositivo de áudio (estetoscópio):</label>
        <select id="audioDevice" [(ngModel)]="selectedDeviceId" [disabled]="isStreaming">
          <option value="default">Padrão do sistema</option>
          @for (device of audioDevices; track device.deviceId) {
            <option [value]="device.deviceId">{{ device.label }}</option>
          }
        </select>
      </div>
    }

    <!-- Indicador de frequência cardíaca -->
    @if (estimatedHeartRate) {
      <div class="heart-rate-display">
        <app-icon name="heart" [size]="32"></app-icon>
        <div class="heart-rate-value">
          <span class="bpm">{{ estimatedHeartRate }}</span>
          <span class="unit">BPM</span>
        </div>
        <span class="label">Frequência Cardíaca Estimada</span>
      </div>
    }

    <!-- Waveform local (paciente transmitindo) -->
    @if (isPatient) {
      <div class="waveform-section">
        <h4>Seu áudio (estetoscópio)</h4>
        <canvas #waveformCanvas class="waveform-canvas" width="600" height="150"></canvas>
      </div>
    }

    <!-- Waveform recebido (médico recebendo) -->
    @if (isProfessional && isReceiving) {
      <div class="waveform-section receiving">
        <h4>
          <span class="live-indicator"></span>
          Áudio do paciente (tempo real)
        </h4>
        <canvas #receivedWaveformCanvas class="waveform-canvas" width="600" height="150"></canvas>
      </div>
    }

    <!-- Controles (só paciente pode iniciar streaming) -->
    @if (isPatient) {
      <div class="recording-controls">
        @if (!isStreaming) {
          <button 
            class="btn btn--primary btn--lg"
            (click)="startStreaming()"
            [disabled]="readonly">
            <app-icon name="mic" [size]="20"></app-icon>
            Iniciar Transmissão
          </button>
          <p class="hint">O som do estetoscópio será transmitido ao médico em tempo real</p>
        } @else {
          <div class="recording-active">
            <div class="recording-indicator">
              <span class="recording-dot"></span>
              <span>Transmitindo...</span>
              <span class="recording-time">{{ formatDuration(recordingDuration) }}</span>
            </div>
            <button 
              class="btn btn--danger btn--lg"
              (click)="stopStreaming()">
              <app-icon name="square" [size]="20"></app-icon>
              Parar Transmissão
            </button>
          </div>
        }
      </div>
    }

    <!-- Placeholder para profissional aguardando -->
    @if (isProfessional && !isReceiving) {
      <div class="waiting-placeholder">
        <app-icon name="headphones" [size]="64"></app-icon>
        <p>Aguardando o paciente iniciar a transmissão do estetoscópio...</p>
        <div class="waveform-bars">
          @for (i of [1,2,3,4,5,6,7,8,9,10]; track i) {
            <div class="waveform-bar"></div>
          }
        </div>
      </div>
    }

    <div class="info-box">
      <app-icon name="alert-circle" [size]="20"></app-icon>
      <div class="info-content">
        <p><strong>Streaming de baixa latência</strong></p>
        <p>
          O áudio do estetoscópio é transmitido em tempo real com filtro especial para 
          sons cardíacos (20-600Hz). A frequência cardíaca é estimada automaticamente 
          pela análise do padrão de batimentos.
        </p>
      </div>
    </div>
  </div>
</div>
