<div class="pep-container">
  @if (loading) {
    <div class="loading-state">
      <app-icon name="loader" [size]="32"></app-icon>
      <p>Carregando prontuário...</p>
    </div>
  }

  @if (error && !loading) {
    <div class="error-state">
      <app-icon name="alert-circle" [size]="32"></app-icon>
      <p>{{ error }}</p>
      <button class="btn-retry" (click)="refresh()">
        <app-icon name="refresh-cw" [size]="16"></app-icon>
        Tentar novamente
      </button>
    </div>
  }

  @if (timeline && !loading) {
    <div class="patient-header">
      <div class="patient-info">
        <div class="patient-avatar">
          <app-icon name="user" [size]="32"></app-icon>
        </div>
        <div class="patient-details">
          <h2>{{ timeline.patientName }}</h2>
          <span class="patient-cpf">CPF: {{ timeline.patientCpf }}</span>
        </div>
      </div>
      <button class="btn-refresh" (click)="refresh()" title="Atualizar">
        <app-icon name="refresh-cw" [size]="18"></app-icon>
      </button>
    </div>

    @if (vitalTrends.length > 0) {
      <div class="vitals-section">
        <h3>
          <app-icon name="activity" [size]="18"></app-icon>
          Últimos Sinais Vitais
        </h3>
        <div class="vitals-grid">
          @for (vital of vitalTrends; track vital.label) {
            <div class="vital-card" [ngClass]="getVitalStatusClass(vital.status)">
              <div class="vital-icon">
                <app-icon [name]="vital.icon" [size]="20"></app-icon>
              </div>
              <div class="vital-content">
                <span class="vital-label">{{ vital.label }}</span>
                <span class="vital-value">{{ vital.value }} <small>{{ vital.unit }}</small></span>
              </div>
              @if (vital.trend) {
                <div class="vital-trend" [ngClass]="'trend-' + vital.trend">
                  <app-icon [name]="getTrendIcon(vital.trend)" [size]="14"></app-icon>
                </div>
              }
            </div>
          }
        </div>
      </div>
    }

    @if (hasAIInsights()) {
      <div class="ai-section">
        <h3>
          <app-icon name="sparkles" [size]="18"></app-icon>
          Insights da IA
        </h3>
        <div class="ai-insights">
          @for (insight of getAIInsights(); track $index) {
            <div class="ai-insight-card">
              <p>{{ insight }}</p>
            </div>
          }
        </div>
      </div>
    }

    <div class="summary-section">
      <div class="summary-stats">
        <div class="stat">
          <span class="stat-value">{{ timeline.summary.totalAppointments }}</span>
          <span class="stat-label">Consultas</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ timeline.summary.totalPrescriptions }}</span>
          <span class="stat-label">Receitas</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ timeline.summary.totalExamRequests }}</span>
          <span class="stat-label">Exames</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ timeline.summary.totalMedicalCertificates }}</span>
          <span class="stat-label">Atestados</span>
        </div>
      </div>
    </div>

    <div class="filters-section">
      <div class="filter-tabs">
        <button class="filter-tab" [class.active]="activeFilter === 'all'" (click)="setFilter('all')">Tudo</button>
        <button class="filter-tab" [class.active]="activeFilter === 'consultations'" (click)="setFilter('consultations')">Consultas</button>
        <button class="filter-tab" [class.active]="activeFilter === 'prescriptions'" (click)="setFilter('prescriptions')">Receitas</button>
        <button class="filter-tab" [class.active]="activeFilter === 'exams'" (click)="setFilter('exams')">Exames</button>
      </div>
      <div class="date-filters">
        <button class="date-btn" [class.active]="dateFilter === 'all'" (click)="setDateFilter('all')">Todos</button>
        <button class="date-btn" [class.active]="dateFilter === '30d'" (click)="setDateFilter('30d')">30d</button>
        <button class="date-btn" [class.active]="dateFilter === '90d'" (click)="setDateFilter('90d')">90d</button>
        <button class="date-btn" [class.active]="dateFilter === '1y'" (click)="setDateFilter('1y')">1 ano</button>
      </div>
    </div>

    <div class="timeline-section">
      @if (filteredEntries.length === 0) {
        <div class="empty-timeline">
          <app-icon name="calendar" [size]="48"></app-icon>
          <p>Nenhum registro encontrado</p>
        </div>
      }

      @for (entry of filteredEntries; track entry.appointmentId) {
        <div 
          class="timeline-entry" 
          [class.current]="isCurrentAppointment(entry)"
          [class.expanded]="selectedEntry?.appointmentId === entry.appointmentId"
          (click)="loadEntryDetails(entry)">
          
          <div class="entry-header">
            <div class="entry-date">
              <span class="day">{{ formatDate(entry.date) }}</span>
              <span class="time">{{ entry.time }}</span>
            </div>
            <div class="entry-info">
              <span class="professional">{{ entry.professionalName }}</span>
              <span class="specialty">{{ entry.specialtyName }}</span>
            </div>
            <div class="entry-status" [ngClass]="getStatusClass(entry.status)">
              {{ getStatusText(entry.status) }}
            </div>
            <div class="entry-badges">
              @if (entry.prescriptionsCount > 0) {
                <span class="badge badge-prescription" title="Receitas">
                  <app-icon name="file-text" [size]="12"></app-icon>
                  {{ entry.prescriptionsCount }}
                </span>
              }
              @if (entry.examRequestsCount > 0) {
                <span class="badge badge-exam" title="Exames">
                  <app-icon name="file" [size]="12"></app-icon>
                  {{ entry.examRequestsCount }}
                </span>
              }
              @if (entry.aiSummary) {
                <span class="badge badge-ai" title="Resumo IA">
                  <app-icon name="sparkles" [size]="12"></app-icon>
                </span>
              }
            </div>
            <app-icon 
              [name]="selectedEntry?.appointmentId === entry.appointmentId ? 'chevron-up' : 'chevron-down'" 
              [size]="18"
              class="expand-icon">
            </app-icon>
          </div>

          @if (selectedEntry?.appointmentId === entry.appointmentId) {
            <div class="entry-details">
              @if (loadingDetails) {
                <div class="loading-details">
                  <app-icon name="loader" [size]="20"></app-icon>
                  <span>Carregando...</span>
                </div>
              } @else {
                @if (selectedEntry?.aiSummary) {
                  <div class="detail-section ai-summary">
                    <h4><app-icon name="sparkles" [size]="16"></app-icon> Resumo da IA</h4>
                    <p>{{ selectedEntry?.aiSummary }}</p>
                  </div>
                }

                @if (selectedEntry?.soap) {
                  <div class="detail-section soap-section">
                    <h4><app-icon name="file-text" [size]="16"></app-icon> Registro SOAP</h4>
                    <div class="soap-grid">
                      @if (selectedEntry?.soap?.subjective) {
                        <div class="soap-item">
                          <span class="soap-letter">S</span>
                          <div class="soap-content">
                            <strong>Subjetivo</strong>
                            <p>{{ selectedEntry?.soap?.subjective }}</p>
                          </div>
                        </div>
                      }
                      @if (selectedEntry?.soap?.objective) {
                        <div class="soap-item">
                          <span class="soap-letter">O</span>
                          <div class="soap-content">
                            <strong>Objetivo</strong>
                            <p>{{ selectedEntry?.soap?.objective }}</p>
                          </div>
                        </div>
                      }
                      @if (selectedEntry?.soap?.assessment) {
                        <div class="soap-item">
                          <span class="soap-letter">A</span>
                          <div class="soap-content">
                            <strong>Avaliação</strong>
                            <p>{{ selectedEntry?.soap?.assessment }}</p>
                          </div>
                        </div>
                      }
                      @if (selectedEntry?.soap?.plan) {
                        <div class="soap-item">
                          <span class="soap-letter">P</span>
                          <div class="soap-content">
                            <strong>Plano</strong>
                            <p>{{ selectedEntry?.soap?.plan }}</p>
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }

                @if (selectedEntry?.biometrics) {
                  <div class="detail-section biometrics-section">
                    <h4><app-icon name="activity" [size]="16"></app-icon> Sinais Vitais</h4>
                    <div class="biometrics-grid">
                      @if (selectedEntry?.biometrics?.bloodPressureSystolic) {
                        <div class="bio-item">
                          <span class="bio-label">Pressão</span>
                          <span class="bio-value">{{ selectedEntry?.biometrics?.bloodPressureSystolic }}/{{ selectedEntry?.biometrics?.bloodPressureDiastolic }} mmHg</span>
                        </div>
                      }
                      @if (selectedEntry?.biometrics?.heartRate) {
                        <div class="bio-item">
                          <span class="bio-label">FC</span>
                          <span class="bio-value">{{ selectedEntry?.biometrics?.heartRate }} bpm</span>
                        </div>
                      }
                      @if (selectedEntry?.biometrics?.oxygenSaturation) {
                        <div class="bio-item">
                          <span class="bio-label">SpO₂</span>
                          <span class="bio-value">{{ selectedEntry?.biometrics?.oxygenSaturation }}%</span>
                        </div>
                      }
                      @if (selectedEntry?.biometrics?.temperature) {
                        <div class="bio-item">
                          <span class="bio-label">Temp</span>
                          <span class="bio-value">{{ selectedEntry?.biometrics?.temperature }}°C</span>
                        </div>
                      }
                      @if (selectedEntry?.biometrics?.weight) {
                        <div class="bio-item">
                          <span class="bio-label">Peso</span>
                          <span class="bio-value">{{ selectedEntry?.biometrics?.weight }} kg</span>
                        </div>
                      }
                      @if (selectedEntry?.biometrics?.height) {
                        <div class="bio-item">
                          <span class="bio-label">Altura</span>
                          <span class="bio-value">{{ selectedEntry?.biometrics?.height }} cm</span>
                        </div>
                      }
                    </div>
                  </div>
                }

                @if ((selectedEntry?.prescriptions?.length ?? 0) > 0) {
                  <div class="detail-section prescriptions-section">
                    <h4><app-icon name="file-text" [size]="16"></app-icon> Prescrições</h4>
                    <div class="prescriptions-list">
                      @for (rx of (selectedEntry?.prescriptions ?? []); track rx.id) {
                        <div class="prescription-card">
                          <div class="rx-header">
                            <span class="rx-date">{{ formatDate(rx.createdAt) }}</span>
                            @if (rx.isSigned) {
                              <span class="rx-signed">
                                <app-icon name="check-circle" [size]="12"></app-icon>
                                Assinada
                              </span>
                            }
                          </div>
                          <div class="rx-meds">
                            @for (med of rx.medications; track $index) {
                              <span class="med-item">{{ med }}</span>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }

                @if ((selectedEntry?.examRequests?.length ?? 0) > 0) {
                  <div class="detail-section exams-section">
                    <h4><app-icon name="file" [size]="16"></app-icon> Solicitações de Exame</h4>
                    <div class="exams-list">
                      @for (exam of (selectedEntry?.examRequests ?? []); track exam.id) {
                        <div class="exam-card">
                          <span class="exam-name">{{ exam.nomeExame }}</span>
                          <span class="exam-date">{{ formatDate(exam.dataEmissao) }}</span>
                        </div>
                      }
                    </div>
                  </div>
                }

                @if ((selectedEntry?.medicalCertificates?.length ?? 0) > 0) {
                  <div class="detail-section certificates-section">
                    <h4><app-icon name="award" [size]="16"></app-icon> Atestados</h4>
                    <div class="certificates-list">
                      @for (cert of (selectedEntry?.medicalCertificates ?? []); track cert.id) {
                        <div class="certificate-card">
                          <span class="cert-date">{{ formatDate(cert.dataEmissao) }}</span>
                          @if (cert.diasAfastamento) {
                            <span class="cert-days">{{ cert.diasAfastamento }} dia(s)</span>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }

                @if (!selectedEntry?.aiSummary && !selectedEntry?.soap && !selectedEntry?.biometrics && 
                     selectedEntry?.prescriptionsCount === 0 && selectedEntry?.examRequestsCount === 0 && selectedEntry?.medicalCertificatesCount === 0) {
                  <div class="empty-details">
                    <app-icon name="info" [size]="20"></app-icon>
                    <p>Nenhuma informação clínica registrada.</p>
                  </div>
                }
              }
            </div>
          }
        </div>
      }
    </div>

    @if (timeline.summary.firstAppointmentDate) {
      <div class="timeline-footer">
        <span>Primeira consulta: {{ formatDate(timeline.summary.firstAppointmentDate) }}</span>
        @if (timeline.summary.lastAppointmentDate) {
          <span>Última: {{ formatDate(timeline.summary.lastAppointmentDate) }}</span>
        }
      </div>
    }
  }
</div>
