<div class="biometrics-container">
  <div class="header">
    <h3>
      <app-icon name="activity" [size]="22"></app-icon>
      Sinais Vitais
    </h3>
    <div class="header-actions">
      @if (isProfessional) {
        <button type="button" class="btn-refresh" (click)="forceRefresh()" [disabled]="isRefreshing" title="Atualizar dados">
          <app-icon [name]="isRefreshing ? 'loader' : 'refresh-cw'" [size]="16" [class.spin]="isRefreshing"></app-icon>
        </button>
      }
      @if (lastUpdated) {
        <span class="updated-at">
          <app-icon name="clock" [size]="14"></app-icon>
          {{ lastUpdated | date:'HH:mm:ss' }}
        </span>
      }
      @if (isSaving) {
        <span class="saving-indicator">
          <app-icon name="loader" [size]="14" class="spin"></app-icon>
          Salvando...
        </span>
      }
    </div>
  </div>

  <!-- Descri√ß√£o e Bot√£o de Captura -->
  <div class="description-section">
    @if (!isProfessional) {
      <p class="description">
        Os valores s√£o capturados automaticamente da maleta ou podem ser digitados manualmente.
      </p>
    } @else {
      <p class="description">
        Dados biom√©tricos do paciente em tempo real.
      </p>
    }
    
    <!-- Bot√£o para buscar dados do cache da maleta - dispon√≠vel para todos -->
    <div class="capture-section">
      <button type="button" class="btn-capture" 
              [disabled]="isCapturing" 
              (click)="capturarSinais()"
              title="Busca os √∫ltimos dados capturados pela maleta e aplica nesta consulta">
        @if (isCapturing) {
          <app-icon name="loader" [size]="18" class="spin"></app-icon>
          Buscando...
        } @else {
          <app-icon name="radio" [size]="18"></app-icon>
          üì° Capturar Sinais
        }
      </button>
      @if (captureMessage) {
        <span class="capture-message" [class.success]="captureSuccess" [class.error]="!captureSuccess">
          {{ captureMessage }}
        </span>
      }
    </div>
  </div>

  <form [formGroup]="biometricsForm" class="biometrics-grid">
    
    <!-- Ox√≠metro: SpO2 -->
    <div class="metric-card">
      <div class="metric-icon spo2">
        <app-icon name="heart" [size]="24"></app-icon>
      </div>
      <div class="metric-content">
        <label>Satura√ß√£o O‚ÇÇ (SpO‚ÇÇ)</label>
        <div class="input-row">
          <div class="input-group">
            <input type="number" formControlName="oxygenSaturation" placeholder="--" [readonly]="isProfessional">
            <span class="unit">%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Frequ√™ncia Card√≠aca -->
    <div class="metric-card">
      <div class="metric-icon heart">
        <app-icon name="heart" [size]="24"></app-icon>
      </div>
      <div class="metric-content">
        <label>Frequ√™ncia Card√≠aca</label>
        <div class="input-row">
          <div class="input-group">
            <input type="number" formControlName="heartRate" placeholder="--" [readonly]="isProfessional">
            <span class="unit">bpm</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Press√£o Arterial -->
    <div class="metric-card double">
      <div class="metric-icon pressure">
        <app-icon name="activity" [size]="24"></app-icon>
      </div>
      <div class="metric-content">
        <label>Press√£o Arterial</label>
        <div class="input-row">
          <div class="input-group">
            <input type="number" formControlName="bloodPressureSystolic" placeholder="Sist." [readonly]="isProfessional">
            <span class="unit">mmHg</span>
          </div>
          <span class="separator">/</span>
          <div class="input-group">
            <input type="number" formControlName="bloodPressureDiastolic" placeholder="Diast." [readonly]="isProfessional">
            <span class="unit">mmHg</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Temperatura -->
    <div class="metric-card">
      <div class="metric-icon temp">
        <app-icon name="thermometer" [size]="24"></app-icon>
      </div>
      <div class="metric-content">
        <label>Temperatura</label>
        <div class="input-row">
          <div class="input-group">
            <input type="number" formControlName="temperature" placeholder="--" step="0.1" [readonly]="isProfessional">
            <span class="unit">¬∞C</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Peso (Balan√ßa) -->
    <div class="metric-card">
      <div class="metric-icon weight">
        <app-icon name="box" [size]="24"></app-icon>
      </div>
      <div class="metric-content">
        <label>Peso</label>
        <div class="input-row">
          <div class="input-group">
            <input type="number" formControlName="weight" placeholder="--" step="0.1" [readonly]="isProfessional">
            <span class="unit">kg</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Altura -->
    <div class="metric-card">
      <div class="metric-icon height">
        <app-icon name="user" [size]="24"></app-icon>
      </div>
      <div class="metric-content">
        <label>Altura</label>
        <div class="input-group">
          <input type="number" formControlName="height" placeholder="--" [readonly]="isProfessional">
          <span class="unit">cm</span>
        </div>
      </div>
    </div>

    <!-- Frequ√™ncia Respirat√≥ria -->
    <div class="metric-card">
      <div class="metric-icon lungs">
        <app-icon name="wind" [size]="24"></app-icon>
      </div>
      <div class="metric-content">
        <label>Freq. Respirat√≥ria</label>
        <div class="input-group">
          <input type="number" formControlName="respiratoryRate" placeholder="--" [readonly]="isProfessional">
          <span class="unit">rpm</span>
        </div>
      </div>
    </div>

    <!-- Glicemia -->
    <div class="metric-card">
      <div class="metric-icon glucose">
        <app-icon name="droplet" [size]="24"></app-icon>
      </div>
      <div class="metric-content">
        <label>Glicemia</label>
        <div class="input-group">
          <input type="number" formControlName="glucose" placeholder="--" [readonly]="isProfessional">
          <span class="unit">mg/dL</span>
        </div>
      </div>
    </div>
  </form>

  <!-- Bot√£o Salvar (apenas para paciente/assistente) -->
  @if (!isProfessional && !readonly) {
    <div class="actions">
      <button type="button" class="btn-save" 
              [disabled]="isSaving || !biometricsForm.valid"
              (click)="onSave()">
        @if (isSaving) {
          <app-icon name="loader" [size]="18" class="spin"></app-icon>
          Salvando...
        } @else {
          <app-icon name="check" [size]="18"></app-icon>
          Salvar Sinais Vitais
        }
      </button>
    </div>
  }

  <!-- Mensagem Bluetooth n√£o dispon√≠vel -->
  @if (!isProfessional && !bluetoothAvailable) {
    <div class="bluetooth-warning">
      <app-icon name="alert-triangle" [size]="16"></app-icon>
      <span>Bluetooth n√£o dispon√≠vel. Use Chrome/Edge em HTTPS para captura autom√°tica.</span>
    </div>
  }
</div>
